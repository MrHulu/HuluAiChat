# 设计：AI 聊天桌面应用 MVP

## 上下文

- 桌面应用，MVP 仅做聊天核心：多模型切换、对话、流式输出、本地历史、可分发。
- 用户自定义 Provider（类似 Cursor），统一 OpenAI 兼容接口。
- 代码遵循 SOLID、KISS、DRY；架构需考虑跨平台（Windows/Linux 优先，远期 Android 仅预留扩展点）。

## 目标 / 非目标

**目标：**

- 实现提案与 5 个 spec 中的能力，且满足各场景。
- UI 与业务、IO 解耦，便于换 UI 或未来移植到其他平台。
- 配置与数据路径跨平台统一，不依赖进程工作目录。

**非目标：**

- 不实现文件/图片分析、语音、翻译等；不与元宝功能对标。
- 不在本阶段实现 Android 端，仅保持核心层可复用。

## 决策

### 决策 1：UI 与运行环境

- **GUI**：Tkinter 或 CustomTkinter（MVP 择一，推荐 CustomTkinter 以贴近现代 Apple 风格）。
- **平台**：优先 Windows，路径与打包按 Windows 设计；通过抽象层保证 Linux/macOS 可运行。

### 决策 2：分层架构

- **Shell 层**：仅负责窗口、控件、事件与展示；不直接调用 API 或 SQLite，通过接口与下层交互。
- **应用/用例层**：薄协调层，编排“发消息、切换模型、加载/保存会话”等流程，依赖抽象接口。
- **领域与 IO 层**：
  - **Chat/API**：统一 OpenAI 兼容客户端，支持流式消费；不依赖具体 UI。
  - **配置**：Provider 列表与当前选中模型的读写，抽象为配置存储接口。
  - **持久化**：会话与消息的 CRUD，抽象为仓储接口，实现用 SQLite。
- 依赖方向：Shell → 应用层 → 领域/IO；领域与 IO 不依赖 Shell，便于测试与换平台。

### 决策 3：配置与数据路径

- **应用数据根目录**：通过单一抽象获取（如 `get_app_data_dir()`），按平台返回：
  - Windows：`%APPDATA%/HuluChat`（或项目最终命名）
  - Linux：`$XDG_CONFIG_HOME/HuluChat` 或 `~/.config/HuluChat`
  - macOS：`~/Library/Application Support/HuluChat`
- **配置文件**：置于上述根目录，如 `config.json`；格式 JSON，结构含 `providers[]`（name, base_url, api_key, model_id）、`current_provider_id`、`theme`（`light` | `dark`）、`sidebar_expanded`（boolean，可选）。
- **SQLite**：置于同一根目录，如 `chat.db`；不依赖 exe 或进程当前工作目录。

### 决策 4：多模型与 API 调用

- 使用 OpenAI 官方 Python 库（`openai`），通过 `base_url` + `api_key` 对接兼容服务（DeepSeek、通义等）。
- “当前模型”由配置中的 `current_provider_id` 决定；切换时仅更新配置或内存中的当前 Provider，不重启应用。
- 请求时携带当前会话内已有消息作为 `messages`，上下文长度由模型/API 限制决定，不做 MVP 级裁剪。

### 决策 5：流式输出与线程

- 流式请求在**后台线程**中执行，通过**队列**将收到的 token 或片段传给主线程。
- 主线程（Tk 主循环）定时或通过队列回调从队列取数据，追加到对话展示控件；禁止在后台线程直接操作 Tk 控件。

### 决策 6：对话持久化模型

- **会话**：id, title, created_at, updated_at（可选）。
- **消息**：id, session_id, role（user/assistant）, content, created_at。
- 新建会话时生成会话记录；每条用户消息与助手回复落库；会话列表按 updated_at 或 created_at 排序。

### 决策 7：打包与可分发

- **工具**：PyInstaller（或约定等价方案）生成 Windows exe。
- **策略**：单文件或目录形式均可；需包含 CustomTkinter（若选用）、openai 等运行时依赖。
- **数据**：exe 运行时仍使用“应用数据根目录”（见决策 3），不在 exe 同目录写入配置与数据库，避免权限与便携盘问题。

### 决策 8：敏感信息

- API Key 仅存于本地配置文件，不写入日志、不上报；设置界面中默认以占位或脱敏显示，不明文展示完整 Key。

### 决策 9：主题与侧边栏

- **主题**：提供明亮（Light）与暗夜（Dark）两套主题色；当前选择持久化到配置，启动时应用。
- **侧边栏**：支持展开（完整会话列表 + 新对话）与收起（仅图标条或展开把手）；展开/收起状态可持久化，便于恢复用户习惯。

---

## UI 层设计

### 主窗口布局（三区）

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [ 标题栏 ]   HuluChat                                    — □ ✕            │
├──────────────┬──────────────────────────────────────────────────────────┤
│              │  顶部栏：当前模型 [DeepSeek ▼]     [ 设置 ]               │
│  侧边栏      ├──────────────────────────────────────────────────────────┤
│  [ 新对话 ]  │                                                            │
│              │  对话区                                                    │
│  会话列表    │  （用户 / 助手 消息气泡或段落，流式时在最后一条追加）        │
│  · 会话 1    │                                                            │
│  · 会话 2    │                                                            │
│  · ...       │                                                            │
│              ├──────────────────────────────────────────────────────────┤
│              │  输入区： [ 多行输入框________________________ ] [ 发送 ]  │
└──────────────┴──────────────────────────────────────────────────────────┘
```

- **侧边栏（左）**：可展开或收起。
  - **展开**：固定宽度（如 220px）。顶部按钮「新对话」；下方为会话列表（标题或首句摘要 + 时间），可点击切换会话；当前会话高亮。提供收起按钮（如箭头或图标）置于侧边栏右缘或顶部栏。
  - **收起**：侧边栏收窄为仅显示图标条（如仅「新对话」图标 + 收起/展开切换），或完全隐藏仅保留主窗口边缘的展开把手；用户点击即可重新展开。展开/收起状态可随主题偏好一并持久化（见下文主题）。
- **主区（右）**：顶部为当前模型下拉与设置入口；中间为对话区（可滚动），每条消息标明角色并按时序排列，流式回复在最后一条助手消息上追加；底部为多行输入框与发送按钮，支持回车发送（可约定 Ctrl+Enter 换行）。

### 设置界面（弹窗或独立页）

设置页**第一项为主题**，其次为模型（Provider）列表；底部保存后关闭弹窗，主窗口模型下拉与当前模型立即刷新（无需重启）。

#### 主题（第一项）

- **控件**：主题使用**下拉框**选择，选项为**文字 + 图标**（如「☀️ 明亮」「🌙 暗夜」）。
- **图标**：使用 CustomTkinter 内的小图或 emoji；图标**随当前主题变色**（如明亮主题下太阳高亮、暗夜主题下月亮高亮），以保持与整体观感一致。
- **两套主题色**：
  - **明亮（Light）**：浅色背景、深色文字，留白与浅灰层级，偏现代 Apple 日间风格。
  - **暗夜（Dark）**：深色背景、浅色文字，低亮度色板，减少刺眼。
- **持久化**：当前主题（`light` / `dark`）写入配置文件，应用启动时读取并应用；未配置时可用默认（如暗夜）。

#### 模型（Provider）列表

- **每行一项 Provider**：名称、Base URL、Model ID、API Key（脱敏显示 + 可编辑）。
- **操作**：新增 Provider、编辑、删除、设为当前模型。

**新增模型的草稿状态**：

- 点击「＋ 新增 Provider」后，新行处于**草稿状态**，视觉上与已保存项区分（如虚线边框、浅色背景或「未保存」标签）。
- 草稿状态下：**不显示「删除」按钮**；右侧主按钮为**「确定」**（非「设为当前」）。
- **校验规则（严格）**：名称非空且长度 1–64、Base URL 为合法 http(s) URL、Model ID 非空（预设或 Custom 时符合格式）、API Key 非空且长度 ≥8。任一不满足则**「确定」置灰不可点**；建议输入变化时实时校验。
- 用户点击「确定」且校验通过后：该条变为已保存状态，按钮变为「设为当前」，「删除」按钮显示，退出草稿状态。

**Model ID 预设与自定义**：

- **预设列表**：提供下拉预选，包含本项目支持的常见模型 ID；用户可选其一，无需手输。
- **Custom**：选项中包含「Custom」；仅当选择 Custom 时显示自定义输入框，并对输入做非空与格式校验。
- **预设名单**（示例，可按实现期更新）：
  - **OpenAI**：`gpt-4o`, `gpt-4o-mini`, `gpt-4-turbo`, `gpt-3.5-turbo`
  - **DeepSeek**：`deepseek-chat`, `deepseek-coder`
  - **通义 (Qwen)**：`qwen-turbo`, `qwen-plus`, `qwen-max`
  - **月之暗面 (Kimi)**：`moonshot-v1-8k`, `moonshot-v1-32k`
  - **智谱 (ChatGLM)**：`glm-4`, `glm-4-flash`, `glm-3-turbo`
  - **Claude**：`claude-sonnet-4-20250514`, `claude-3-5-sonnet-20241022`, `claude-3-5-haiku-20241022`（或当前 API 常用 id）
  - **自定义**：`Custom`（选中后显示自定义 Model ID 输入框）

### 视觉与交互约定

- **风格**：简洁、偏现代 Apple 风（留白、圆角、清晰层级）；明亮/暗夜两套主题下均保持一致的控件样式与对比度。
- **对话区**：用户消息与助手消息在视觉上可区分（如对齐方式或背景色）；流式进行中可显示加载指示或“正在输入…”。
- **空状态**：无会话时侧边栏为空；无消息时对话区展示简短引导（如“新对话，在下方输入并发送”）。
- **错误**：API 或网络错误在对话区或顶部以非阻塞方式提示（如小横幅或当前输入区上方），不覆盖整屏。

### 原型图

- 见项目内 `openspec/changes/add-ai-chat-app/ui-prototype.png`，用于评审主窗口与布局；设置界面可在后续迭代补充原型。
