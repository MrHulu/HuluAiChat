# 提案：聊天 UI 与侧边栏会话优化

## 为什么

当前 HuluChat 在以下方面体验不足：对话区仅显示纯文本，AI 输出多为 Markdown 无法阅读；侧边栏折叠后视觉上未真正收窄；会话列表标题始终为「新对话」且无法区分；会话无法删除，重命名/删除若用文字会占用空间。需要一次针对性优化以提升可用性。

## 什么变化

- **对话区富文本**：消息内容（尤其助手回复）支持 Markdown 渲染，便于阅读代码块、列表、加粗等。
- **侧边栏折叠修复**：收起侧边栏时实际收窄到图标条宽度，不因内部控件撑开而失效。
- **会话标题**：新建会话在首轮对话完成后自动用首条用户消息摘要更新标题一次；支持用户重命名。
- **会话列表操作**：支持删除会话；重命名与删除使用图标而非文字，节省空间并统一交互。

## 能力

### 新能力

- **消息区 Markdown 渲染**：助手与用户消息（可选）以富文本展示，支持常见 Markdown 语法（标题、列表、代码块、加粗、链接等）；流式输出可采用「流结束后再渲染」或「增量渲染」策略之一。
- **侧边栏可靠折叠**：侧边栏展开/收起时宽度与内容一致，收起时仅显示新对话图标与展开箭头，不出现撑开或错位。
- **会话标题自动更新**：当会话标题仍为默认「新对话」时，在首轮流式完成后自动用首条用户消息的摘要（如前 N 字或首行）更新会话标题，且仅自动更新一次；用户手动重命名后不再自动覆盖。
- **会话重命名**：用户在侧边栏会话项上通过图标触发重命名（弹窗或内联编辑），调用现有 `update_session_title`，列表即时刷新。
- **会话删除**：用户在侧边栏通过图标删除会话；若删除当前会话则切换至其他会话或空状态；持久层删除会话及其消息（或仅会话并保留消息，由设计决定）。

### 修改的能力

- **侧边栏布局与折叠逻辑**：修复折叠后列宽与子控件显示，使收起态与设计一致。
- **会话列表项**：由单一标题按钮改为「标题 + 重命名图标 + 删除图标」的布局，图标替代文字。

## 影响

- **UI 层**：`src/ui/main_window.py` — 对话区消息展示（引入 Markdown 控件或渲染逻辑）、侧边栏 grid/折叠、会话列表项结构与事件。
- **应用层**：`src/app/service.py` — 流式完成后触发会话标题自动更新、新增 `delete_session`、与重命名/删除的调用。
- **持久层**：`src/persistence/session_repo.py`（及可选 `message_repo`）— 新增会话删除接口；若级联删消息则需在 repo 或 service 中实现。
- **依赖**：若采用现成 Markdown 组件（如 `ctk-markdown`），需在 `requirements.txt` 中新增依赖。

## 非目标（本变更之外）

- 不支持图片/文件上传、语音输入等输入形态。
- 不改变现有配置、主题、Provider 管理逻辑。
- 不实现会话导出/导入、多选删除等批量能力。
